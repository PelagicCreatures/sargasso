<!DOCTYPE html>
<html>

<head>
  <title>Example Sargasso Element w/Data Observing &amp; Template Rendering</title>
</head>

<body>
  <h3>Example Sargasso Element w/Data Observing &amp; Template Rendering</h3>

  <!-- ToDoList custom element -->
  <sargasso-to-do-list></sargasso-to-do-list>

  <!-- enable es6 modules -->
  <script async src="https://unpkg.com/es-module-shims@0.13.1/dist/es-module-shims.js"></script>
  <!-- https://unpkg.com/@pelagiccreatures/sargasso/dist/sargasso.mjs -->
  <script type="importmap">
  {
    "imports": {
      "@pelagiccreatures/sargasso": "/dist/sargasso.mjs"
    }
  }
  </script>
  <script type="module">
    import { Sargasso, ObservableObject, utils } from "@pelagiccreatures/sargasso"
    import {
      html,render
    } from 'https://unpkg.com/lit-html?module'

    // set up an ObservableObject with the id "todo"
    let todo = {
      count: 0,
      list: [
      ]
    };

    // set up proxy/reflect notifictaion service for todo
    window.todo = new ObservableObject("todo", todo).data;

    // Define ToDoList as a subclass of Sargasso
    // Sargasso will re-render the template whenever data in ObservableObject "todo" is changed
    class ToDoList extends Sargasso {
      constructor(element, options = {}) {
        options.shadowDOM = true // put the element in a shadow DOM
        super(element, options)


        // define lit html template.
        let template = (args) => html`
          <strong>Look! A ToDo List!</strong>
          <ul>
            ${args.list.map((item) => html`<li data-index=${item.id}><input type="checkbox" id=${item.id}> ${item.name}</li>`)}
          </ul>
          <input type="text" id="new" placeholder="add to list" autofocus> <input type="submit" value="add item">
        `;

        this.setRenderer(render); // set lit-html render() as the renderer
        this.setTemplate(template); // set template function
      }

      start() {
        super.start();

        // start watching for changes
        this.observableStart("todo")
        // hook up observable data - any changes will re-render element
        this.setTemplateArgs(this.getObservableData("todo"));


        // delegated click event handler for checkboxes
        // remove item from list
        this.on("click", '[type="checkbox"]', e => {
          e.preventDefault()
          let todo = this.getObservableData("todo");
          let id = parseInt(e.target.getAttribute('id'))
          for(let i = 0; i < todo.list.length; i++) {
            const item = todo.list[i]
            if(item.id === id) {
              todo.list.splice(i, 1);
              break
            }
          }
        })

        // delegated click event handler for add item button
        // add item to list
        this.on("click", '[type="submit"]', e => {
          let inp = this.element.querySelector("#new");
          if(inp.value) {
            let name = inp.value;
            inp.value = "";

            let todo = this.getObservableData("todo");

            todo.list.push({
              id: ++todo.count,
              done: false,
              name: name
            });
          }
        });
      }
    }

    // Register ToDoList custom element to the Sargasso framework
    utils.registerSargassoClass("ToDoList", ToDoList)

    utils.bootSargasso()
  </script>
</body>

</html>
